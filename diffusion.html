<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <style>
    body, html{ margin: 0;}
    circle{ fill: blue; }
    path{ stroke: black; stroke-width: 1; fill: none;}
    .eye line, .eye path{
      stroke: black;
      stroke-width: 6;
      fill: none;
    }
    path.ray{
      /*stroke-dasharray: 5, 4;*/
      stroke-width: 1;
      stroke-linejoin: bevel;
      opacity: 1;
      stroke: blue;
    }
    .surface{
      stroke-width: 2;
      stroke: black;
    }

  </style>
  <body>
    <svg></svg>
    <script src="d3.js"></script>
    <script src="vec.js"></script>
    <script src="geo.js"></script>
    <script>
var w = window.innerWidth, h = window.innerHeight
  , max = Math.max(w, h), min = Math.min(w, h), pi = Math.PI, abs = Math.abs
  , cos = Math.cos, sin = Math.sin
  , svg = d3.select('svg').attr({width: w, height: h})
  , rand = function(n){ return Math.random() * n }
  , translate = function(x,y){ return 'translate(' + x + ',' + y + ')' }
  , line = d3.svg.line()
  , n = 100, m = 0, num_rays = 50, ray_len = 10000



// surface is an array of line segments of the form: [p1, p2]
// so surface looks like: [ [p1, p2], [p2, p3], ... ]
// where each `p*` is a ponit, described as a 2 element array. ie., [343, 253]
/*
var surface = [
  [ // line segment 1
      [ p1x, p2y ]
    , [ p2x, p2y ]
  ]
  , [ // line segment 2
      [ p2x, p2y ]
    , [ p3x, p3y ]
  ]
  etc...
]
*/


var surface = surface_open_box([w * 0.8, h * 0.25], [5, h / 2])

// surface = surface.concat(surface_pinhole([w * 0.5, h * 0.25], [w * 0.5, h * 0.75], 10))

// add a box
// box surrounding window

var mouse = [w/2, h/2]
d3.select('body').on('mousemove', function(){ mouse = d3.mouse(this) })


// create the source rays given the source light positions
function source_rays(source_pos, rot, spray){
  return d3.range(num_rays).map(function(d){
    var theta = spray * (d + 1) / num_rays - spray / 2 - rot
    return [ source_pos, [ cos(theta), sin(theta) ] ]
  })
}

// draw loop

var sources_num = 1 // num_rays
var sources_rots = //d3.range(sources_num).map(function(d){ return rand(2 * pi) })
  d3.range(sources_num).map(function(d){ return 0 })
var sources_spray = 
  d3.range(sources_num).map(function(d){ return pi * 0.3 })

d3.timer(function(){
  
  svg.selectAll('*').remove()

  svg.append('g').selectAll('line').data(surface).enter()
    .append('line').attr({ 
      'class': 'surface'
      , x1: function(d){ return d[0][0] }
      , y1: function(d){ return d[0][1] }
      , x2: function(d){ return d[1][0] }
      , y2: function(d){ return d[1][1] }
    })

  // light sources
  var sources;
  if(sources_num > 1) sources = points_circle(mouse, 40, sources_num)
  else sources = [mouse.slice(0)]

  var rays = d3.merge(sources.map(function(source, i){
    return source_rays(source, sources_rots[i], sources_spray[i])
      .map(ray_trace.bind(null, surface, 10))
  }))

  svg.append('g').selectAll('path').data(rays)
    .enter().append('path').attr({d: line, 'class': 'ray'})

})

    </script>
  </body>
</html>