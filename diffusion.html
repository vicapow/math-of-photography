<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <style>
    body, html{ margin: 0; background-color: black;}
    circle{ fill: blue; }
    path{ stroke: black; stroke-width: 1; fill: none;}
    .eye line, .eye path{
      stroke: black;
      stroke-width: 6;
      fill: none;
    }
    path.ray{
      /*stroke-dasharray: 5, 4;*/
      stroke-width: 2;
      stroke-linejoin: bevel;
      opacity: 1;
      stroke: white;
    }
    .surface{
      stroke-width: 2;
      stroke: green;
    }

  </style>
  <body>
    <svg></svg>
    <script src="d3.js"></script>
    <script src="geo.js"></script>
    <script src="common.js"></script>
    <script>

var svg = d3.select('svg').attr({width: w, height: h})
  , translate = function(x,y){ return 'translate(' + x + ',' + y + ')' }
  , ray_lives = 3
  //, color = d3.scale.linear().domain(['#000000', '#ffffff']).range([0, 1])
  , color = d3.scale.category10()


// surface is an array of line segments of the form: [p1, p2]
// so surface looks like: [ [p1, p2], [p2, p3], ... ]
// where each `p*` is a ponit, described as a 2 element array. ie., [343, 253]
/*
var surface = [
  [ // line segment 1
      [ p1x, p2y ]
    , [ p2x, p2y ]
  ]
  , [ // line segment 2
      [ p2x, p2y ]
    , [ p3x, p3y ]
  ]
  etc...
]
*/

var surfaces = []

// add the back of the box
surfaces.push({
  geometry: surface_open_box([w * 0.8, h * 0.1], [5, h * 0.8])
  , material: { diffusion: 1 /* randomness */, reflection: 0 /* bounciness */ }
})

// add the pin hole
// surfaces.push({
//   geometry: surface_pinhole([w * 0.5, h * 0.1], [w * 0.5, h * 0.9], 10)
//   , material: { diffusion: 1, reflection: 0 }
// })

// add a box
// box surrounding window



var sources = d3.range(1).map(function(d){
  return { 
    rays: 50 // number of rays the ligh source will emit
    , rotation: pi * 0.0
    , spray: pi * 2
    , position: mouse
    , color: color(d)
  }
})

// draw loop
d3.timer(function(){
// setInterval(function(){
  
  svg.selectAll('*').remove()

  svg.append('g').selectAll('g').data(surfaces).enter()
    .append('g').selectAll('line')
      .data(function(d){ return d.geometry })
      .enter().append('line')
      .attr({ 
        'class': 'surface'
        , x1: function(d){ return d[0][0] }
        , y1: function(d){ return d[0][1] }
        , x2: function(d){ return d[1][0] }
        , y2: function(d){ return d[1][1] }
      })

  // light sources
  if(sources.length > 1) points_line(mouse, 300, sources.length)
    .forEach(function(position, i){ sources[i].position = position })
  else sources[0].position = mouse.slice(0)

  var rays = d3.merge(sources.map(function(source){
    return source_rays(source, ray_lives)
  }))

  rays = ray_trace(surfaces, 20, 2000, rays)

  svg.append('g').selectAll('path').data(rays)
    .enter().append('path').attr({
      d: function(ray){ return line(ray.values) }
      , 'class': 'ray'
    }).style({ opacity: 0.3, stroke: function(ray){ return ray.source.color } })
}, 1000)

    </script>
  </body>
</html>